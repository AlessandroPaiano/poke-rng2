<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>Gen 1 RNG Gym Run</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&family=VT323:wght@400&display=swap" rel="stylesheet">
  <style>
/* ============================================================
   GEN 1 RNG GYM RUN — Retro Pixel / Dark Mode First
   ============================================================ */

:root {
  --bg: #0f0f1a;
  --bg2: #161629;
  --bg3: #1e1e35;
  --border: #3a3a6e;
  --accent: #f8e71c;
  --accent2: #e94040;
  --accent3: #3ddc84;
  --text: #e8e8ff;
  --text2: #9898cc;
  --panel-bg: #161629;
  --panel-border: #3a3a6e;
  --slot-empty: #1a1a2e;
  --slot-border: #2a2a4e;
  --win-bar-bg: #0a0a1a;
  --win-bar-fill: #3ddc84;
  --pointer: #f8e71c;
  --log-bg: #0a0a14;
  --shadow: 0 2px 16px #000a;
  --pixel-font: 'Press Start 2P', monospace;
  --body-font: 'VT323', monospace;
}

[data-theme="light"] {
  --bg: #e8e8f4;
  --bg2: #d8d8ec;
  --bg3: #c8c8dc;
  --border: #9898cc;
  --accent: #e87c00;
  --accent2: #cc1010;
  --accent3: #1a8a40;
  --text: #101030;
  --text2: #404068;
  --panel-bg: #dcdcf0;
  --panel-border: #9898cc;
  --slot-empty: #c8c8dc;
  --slot-border: #9898cc;
  --win-bar-bg: #b8b8d0;
  --win-bar-fill: #1a8a40;
  --pointer: #e87c00;
  --log-bg: #d0d0e4;
  --shadow: 0 2px 16px #0004;
}

*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

html { font-size: 16px; }

body {
  background: var(--bg);
  color: var(--text);
  font-family: var(--body-font);
  font-size: 1.1rem;
  min-height: 100vh;
  display: flex;
  flex-direction: column;
  gap: 0;
}

/* ---- TOP BAR ---- */
#topbar {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 10px 16px;
  background: var(--bg2);
  border-bottom: 2px solid var(--border);
  position: sticky;
  top: 0;
  z-index: 100;
  box-shadow: var(--shadow);
}

#title-wrap {
  display: flex;
  align-items: center;
  gap: 10px;
}

.pixel-ball {
  font-size: 1.5rem;
  color: var(--accent);
  animation: blink 2s infinite;
}

@keyframes blink {
  0%,49%{opacity:1}50%,100%{opacity:0.4}
}

#topbar h1 {
  font-family: var(--pixel-font);
  font-size: clamp(0.45rem, 2vw, 0.7rem);
  color: var(--accent);
  text-shadow: 2px 2px 0 #000, 0 0 16px var(--accent);
  letter-spacing: 1px;
  line-height: 1.4;
}

#top-controls {
  display: flex;
  gap: 8px;
}

#top-controls button {
  background: var(--bg3);
  border: 2px solid var(--border);
  color: var(--text);
  font-family: var(--pixel-font);
  font-size: 0.7rem;
  padding: 6px 10px;
  cursor: pointer;
  transition: background 0.15s, color 0.15s, border-color 0.15s;
}

#top-controls button:hover {
  background: var(--accent);
  color: #000;
  border-color: var(--accent);
}

/* ---- PHASE BANNER ---- */
#phase-banner {
  background: var(--bg3);
  border-bottom: 2px solid var(--border);
  padding: 8px 16px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  font-family: var(--pixel-font);
  font-size: clamp(0.45rem, 1.5vw, 0.6rem);
}

#phase-label {
  color: var(--accent);
}

#stage-label {
  color: var(--text2);
  font-size: 0.75em;
}

/* ---- MAIN LAYOUT ---- */
#app {
  display: grid;
  grid-template-columns: 1fr;
  gap: 16px;
  padding: 16px;
  flex: 1;
}

@media (min-width: 700px) {
  #app {
    grid-template-columns: 360px 1fr;
  }
}

/* ---- WHEEL SECTION ---- */
#wheel-section {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 12px;
}

#wheel-container {
  position: relative;
  width: 340px;
  height: 340px;
  max-width: 100%;
}

#wheel-canvas {
  width: 100%;
  height: 100%;
  border-radius: 50%;
  box-shadow: 0 0 32px #0008, 0 0 8px var(--accent)44;
  display: block;
}

#wheel-pointer {
  position: absolute;
  top: -18px;
  left: 50%;
  transform: translateX(-50%);
  font-size: 2rem;
  color: var(--pointer);
  text-shadow: 0 0 8px var(--pointer), 2px 2px 0 #000;
  pointer-events: none;
  z-index: 10;
  filter: drop-shadow(0 2px 4px #000a);
}

#wheel-result-label {
  font-family: var(--pixel-font);
  font-size: clamp(0.5rem, 2vw, 0.65rem);
  color: var(--accent3);
  text-align: center;
  min-height: 2em;
  text-shadow: 0 0 8px var(--accent3)88;
}

.spin-btn {
  font-family: var(--pixel-font);
  font-size: clamp(0.6rem, 2.5vw, 0.85rem);
  padding: 14px 36px;
  background: var(--accent);
  color: #000;
  border: 3px solid #000;
  cursor: pointer;
  box-shadow: 4px 4px 0 #000;
  transition: transform 0.1s, box-shadow 0.1s;
  text-transform: uppercase;
  letter-spacing: 2px;
}

.spin-btn:hover:not(:disabled) {
  transform: translate(-2px,-2px);
  box-shadow: 6px 6px 0 #000;
}

.spin-btn:active:not(:disabled) {
  transform: translate(2px,2px);
  box-shadow: 2px 2px 0 #000;
}

.spin-btn:disabled {
  background: var(--text2);
  cursor: not-allowed;
  box-shadow: 2px 2px 0 #000;
  color: #666;
}

#spin-queue-label {
  font-family: var(--pixel-font);
  font-size: 0.5rem;
  color: var(--text2);
  text-align: center;
  min-height: 1.5em;
}

/* ---- PANELS ---- */
.panel {
  background: var(--panel-bg);
  border: 2px solid var(--panel-border);
  padding: 12px;
  margin-bottom: 12px;
  box-shadow: var(--shadow);
}

.panel h2 {
  font-family: var(--pixel-font);
  font-size: clamp(0.45rem, 1.5vw, 0.6rem);
  color: var(--accent);
  border-bottom: 1px solid var(--border);
  padding-bottom: 6px;
  margin-bottom: 10px;
  text-shadow: 1px 1px 0 #000;
}

/* ---- PARTY GRID ---- */
#party-grid {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 8px;
}

.party-slot {
  background: var(--slot-empty);
  border: 2px solid var(--slot-border);
  padding: 8px 4px;
  text-align: center;
  min-height: 70px;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  gap: 2px;
  font-family: var(--body-font);
  font-size: 0.95rem;
  transition: border-color 0.2s, background 0.2s;
  position: relative;
}

.party-slot.empty::after {
  content: '—';
  color: var(--slot-border);
  font-size: 1.2rem;
}

.party-slot.filled {
  border-color: var(--accent);
  background: var(--bg3);
}

.party-slot.filled.bonus {
  border-color: var(--accent2);
  border-style: dashed;
}

.slot-name {
  font-family: var(--pixel-font);
  font-size: 0.38rem;
  color: var(--text);
  line-height: 1.5;
  word-break: break-all;
}

.slot-types {
  display: flex;
  gap: 3px;
  flex-wrap: wrap;
  justify-content: center;
}

.type-badge {
  font-family: var(--pixel-font);
  font-size: 0.3rem;
  padding: 2px 4px;
  border-radius: 2px;
  text-transform: uppercase;
}

/* Type colors */
.type-Normal   { background:#a8a878; color:#000 }
.type-Fire     { background:#f08030; color:#000 }
.type-Water    { background:#6890f0; color:#fff }
.type-Electric { background:#f8d030; color:#000 }
.type-Grass    { background:#78c850; color:#000 }
.type-Ice      { background:#98d8d8; color:#000 }
.type-Fighting { background:#c03028; color:#fff }
.type-Poison   { background:#a040a0; color:#fff }
.type-Ground   { background:#e0c068; color:#000 }
.type-Flying   { background:#a890f0; color:#fff }
.type-Psychic  { background:#f85888; color:#fff }
.type-Bug      { background:#a8b820; color:#000 }
.type-Rock     { background:#b8a038; color:#000 }
.type-Ghost    { background:#705898; color:#fff }
.type-Dragon   { background:#7038f8; color:#fff }
.type-Mixed    { background:#666; color:#fff }

.slot-contrib {
  font-size: 0.7rem;
  color: var(--accent3);
  font-family: var(--pixel-font);
  font-size: 0.32rem;
}

/* ---- WIN CHANCE BAR ---- */
#win-chance-bar-wrap {
  display: flex;
  align-items: center;
  gap: 10px;
  margin-bottom: 8px;
}

#win-chance-bar {
  flex: 1;
  height: 16px;
  background: var(--win-bar-bg);
  border: 2px solid var(--border);
  overflow: hidden;
  position: relative;
}

#win-chance-fill {
  display: block;
  height: 100%;
  background: var(--win-bar-fill);
  width: 0%;
  transition: width 0.6s ease;
  box-shadow: 0 0 8px var(--accent3)88;
}

#win-chance-pct {
  font-family: var(--pixel-font);
  font-size: 0.7rem;
  color: var(--accent3);
  min-width: 40px;
}

#battle-breakdown {
  font-family: var(--body-font);
  font-size: 1rem;
  line-height: 1.5;
  color: var(--text2);
}

#battle-breakdown .contrib-row {
  display: flex;
  justify-content: space-between;
  border-bottom: 1px dotted var(--border);
  padding: 2px 0;
}

#battle-breakdown .contrib-row span:first-child {
  color: var(--text);
}

.contrib-vs { color: var(--accent3); font-size: 0.85rem; }
.contrib-bonus { color: var(--accent); }

/* ---- INVENTORY ---- */
#inventory-list {
  display: flex;
  flex-direction: column;
  gap: 4px;
  font-family: var(--body-font);
  font-size: 1.1rem;
}

.inv-row {
  display: flex;
  justify-content: space-between;
  align-items: center;
  border-bottom: 1px dotted var(--border);
  padding: 2px 0;
}

.inv-name {
  color: var(--text);
}

.inv-count {
  font-family: var(--pixel-font);
  font-size: 0.55rem;
  color: var(--accent);
}

.inv-permanent {
  color: var(--accent3);
  font-size: 0.75em;
}

/* ---- STAGE INFO ---- */
#stage-info {
  font-family: var(--body-font);
  font-size: 1.15rem;
  line-height: 1.6;
  color: var(--text2);
}

#stage-info strong {
  color: var(--text);
}

/* ---- RUN LOG ---- */
#log-section {
  padding: 12px 16px;
  background: var(--log-bg);
  border-top: 2px solid var(--border);
}

#log-section h2 {
  font-family: var(--pixel-font);
  font-size: 0.55rem;
  color: var(--accent);
  margin-bottom: 8px;
}

#run-log {
  max-height: 180px;
  overflow-y: auto;
  font-family: var(--body-font);
  font-size: 1rem;
  line-height: 1.5;
  color: var(--text2);
  padding-right: 4px;
}

#run-log::-webkit-scrollbar { width: 6px; }
#run-log::-webkit-scrollbar-track { background: var(--bg2); }
#run-log::-webkit-scrollbar-thumb { background: var(--border); }

.log-entry {
  padding: 2px 0;
  border-bottom: 1px solid var(--bg3);
  animation: logFadeIn 0.3s ease;
}
@keyframes logFadeIn { from{opacity:0;transform:translateX(-8px)} to{opacity:1;transform:none} }

.log-entry .log-icon { margin-right: 6px; }
.log-win  { color: var(--accent3); }
.log-lose { color: var(--accent2); }
.log-info { color: var(--text2); }
.log-capture { color: #80c0ff; }
.log-item { color: var(--accent); }
.log-evolve { color: #c080ff; }
.log-crit { color: var(--accent2); }

/* ---- OVERLAY ---- */
#overlay {
  position: fixed;
  inset: 0;
  background: #000c;
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 1000;
  animation: fadeIn 0.4s ease;
}

#overlay.hidden { display: none; }

@keyframes fadeIn { from{opacity:0} to{opacity:1} }

#overlay-content {
  background: var(--bg2);
  border: 3px solid var(--accent);
  padding: 32px 40px;
  text-align: center;
  box-shadow: 8px 8px 0 #000, 0 0 40px var(--accent)44;
  max-width: 90vw;
}

#overlay-title {
  font-family: var(--pixel-font);
  font-size: clamp(0.7rem, 3vw, 1.1rem);
  color: var(--accent);
  margin-bottom: 16px;
  text-shadow: 2px 2px 0 #000;
}

#overlay-msg {
  font-family: var(--body-font);
  font-size: 1.3rem;
  color: var(--text2);
  margin-bottom: 24px;
  line-height: 1.6;
}

#overlay-restart {
  font-family: var(--pixel-font);
  font-size: 0.65rem;
  padding: 12px 28px;
  background: var(--accent);
  color: #000;
  border: 3px solid #000;
  cursor: pointer;
  box-shadow: 4px 4px 0 #000;
}

#overlay-restart:hover {
  transform: translate(-2px,-2px);
  box-shadow: 6px 6px 0 #000;
}

/* ---- RESPONSIVE ---- */
@media (max-width: 699px) {
  #info-section {
    display: flex;
    flex-direction: column;
    gap: 0;
  }
  #party-grid { grid-template-columns: repeat(3,1fr); }
}

/* ---- SPIN ANIMATION STATE ---- */
.spinning-indicator {
  animation: pulse 0.5s infinite alternate;
}
@keyframes pulse {
  from { box-shadow: 0 0 8px var(--accent)44; }
  to   { box-shadow: 0 0 24px var(--accent)aa; }
}

/* Wheel canvas glow when spinning */
.wheel-spinning {
  animation: wheelGlow 0.3s infinite alternate;
}
@keyframes wheelGlow {
  from { box-shadow: 0 0 32px #0008, 0 0 8px var(--accent)44; }
  to   { box-shadow: 0 0 32px #0008, 0 0 32px var(--accent)99; }
}

/* ── Additions ── */
#pointer-label{font-family:var(--pf,'VT323',monospace);font-size:clamp(.55rem,2vw,.72rem);color:var(--accent,#f8e71c);text-align:center;min-height:1.8em;letter-spacing:1px;text-shadow:0 0 10px var(--accent,#f8e71c)99;transition:color .2s}
#spin-popup{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;z-index:500;background:#0006}
#spin-popup.hidden{display:none}
#spin-popup-inner{background:var(--bg2,#1a1a2e);border:3px solid var(--accent,#f8e71c);padding:28px 44px;box-shadow:6px 6px 0 #000,0 0 40px var(--accent,#f8e71c)66;text-align:center;animation:popIn .25s cubic-bezier(.34,1.56,.64,1)}
#spin-popup-label{font-family:var(--pf,'VT323',monospace);font-size:clamp(1rem,5vw,1.6rem);color:var(--accent,#f8e71c);text-shadow:2px 2px 0 #000,0 0 16px var(--accent,#f8e71c);letter-spacing:2px}
@keyframes popIn{from{transform:scale(.4);opacity:0}to{transform:scale(1);opacity:1}}
  </style>
</head>
<body>
  <header id="topbar">
    <div id="title-wrap">
      <span class="pixel-ball">◉</span>
      <h1>Gen 1 RNG Gym Run</h1>
    </div>
    <div id="top-controls">
      <button id="darkModeToggle" title="Toggle Dark/Light">☾</button>
      <button id="restartBtn" title="Restart Run">↺</button>
    </div>
  </header>

  <div id="phase-banner">
    <span id="phase-label">Starter Selection</span>
    <span id="stage-label"></span>
  </div>

  <main id="app">
    <section id="wheel-section">
      <div id="wheel-container">
        <canvas id="wheel-canvas" width="340" height="340"></canvas>
        <div id="wheel-pointer">▼</div>
      </div>
      <div id="pointer-label"></div>
      <div id="wheel-result-label">Loading...</div>
      <button id="spinBtn" class="spin-btn" disabled>SPIN!</button>
      <div id="spin-queue-label"></div>
    </section>

    <aside id="info-section">
      <div class="panel" id="party-panel">
        <h2>Party</h2>
        <div id="party-grid">
          <div class="party-slot empty" id="slot-0"></div>
          <div class="party-slot empty" id="slot-1"></div>
          <div class="party-slot empty" id="slot-2"></div>
          <div class="party-slot empty" id="slot-3"></div>
          <div class="party-slot empty" id="slot-4"></div>
          <div class="party-slot empty" id="slot-5"></div>
        </div>
      </div>

      <div class="panel" id="battle-panel">
        <h2>Battle Odds</h2>
        <div id="win-chance-bar-wrap">
          <div id="win-chance-bar"><span id="win-chance-fill"></span></div>
          <span id="win-chance-pct">—%</span>
        </div>
        <div id="battle-breakdown"></div>
      </div>

      <div class="panel" id="inventory-panel">
        <h2>Bag</h2>
        <div id="inventory-list"></div>
      </div>

      <div class="panel" id="stage-panel">
        <h2>Next Stage</h2>
        <div id="stage-info"></div>
      </div>
    </aside>
  </main>

  <section id="log-section">
    <h2>Run Log</h2>
    <div id="run-log"></div>
  </section>

  <div id="overlay" class="hidden">
    <div id="overlay-content">
      <h2 id="overlay-title"></h2>
      <p id="overlay-msg"></p>
      <button id="overlay-restart">New Run</button>
    </div>
  </div>

  <div id="spin-popup" class="hidden">
    <div id="spin-popup-inner">
      <div id="spin-popup-label"></div>
    </div>
  </div>

<script>
/* ============================================================
   Gen 1 RNG Gym Run — app.js
   Vanilla JS, no build step, GitHub Pages compatible
   All JSON data inlined — no fetch() calls needed
   ============================================================ */

// ── Inlined Game Data ──────────────────────────────────────────
const INLINE_POKEDEX = [{"dexNumber":1,"name":"Bulbasaur","type1":"Grass","type2":"Poison","tier":"Common","evolvesTo":2,"bst":318},{"dexNumber":2,"name":"Ivysaur","type1":"Grass","type2":"Poison","tier":"Uncommon","evolvesTo":3,"bst":405},{"dexNumber":3,"name":"Venusaur","type1":"Grass","type2":"Poison","tier":"Rare","evolvesTo":null,"bst":525},{"dexNumber":4,"name":"Charmander","type1":"Fire","type2":null,"tier":"Common","evolvesTo":5,"bst":309},{"dexNumber":5,"name":"Charmeleon","type1":"Fire","type2":null,"tier":"Uncommon","evolvesTo":6,"bst":405},{"dexNumber":6,"name":"Charizard","type1":"Fire","type2":"Flying","tier":"Rare","evolvesTo":null,"bst":534},{"dexNumber":7,"name":"Squirtle","type1":"Water","type2":null,"tier":"Common","evolvesTo":8,"bst":314},{"dexNumber":8,"name":"Wartortle","type1":"Water","type2":null,"tier":"Uncommon","evolvesTo":9,"bst":405},{"dexNumber":9,"name":"Blastoise","type1":"Water","type2":null,"tier":"Rare","evolvesTo":null,"bst":530},{"dexNumber":10,"name":"Caterpie","type1":"Bug","type2":null,"tier":"Common","evolvesTo":11,"bst":195},{"dexNumber":11,"name":"Metapod","type1":"Bug","type2":null,"tier":"Common","evolvesTo":12,"bst":205},{"dexNumber":12,"name":"Butterfree","type1":"Bug","type2":"Flying","tier":"Uncommon","evolvesTo":null,"bst":395},{"dexNumber":13,"name":"Weedle","type1":"Bug","type2":"Poison","tier":"Common","evolvesTo":14,"bst":195},{"dexNumber":14,"name":"Kakuna","type1":"Bug","type2":"Poison","tier":"Common","evolvesTo":15,"bst":205},{"dexNumber":15,"name":"Beedrill","type1":"Bug","type2":"Poison","tier":"Uncommon","evolvesTo":null,"bst":395},{"dexNumber":16,"name":"Pidgey","type1":"Normal","type2":"Flying","tier":"Common","evolvesTo":17,"bst":251},{"dexNumber":17,"name":"Pidgeotto","type1":"Normal","type2":"Flying","tier":"Common","evolvesTo":18,"bst":349},{"dexNumber":18,"name":"Pidgeot","type1":"Normal","type2":"Flying","tier":"Uncommon","evolvesTo":null,"bst":479},{"dexNumber":19,"name":"Rattata","type1":"Normal","type2":null,"tier":"Common","evolvesTo":20,"bst":253},{"dexNumber":20,"name":"Raticate","type1":"Normal","type2":null,"tier":"Common","evolvesTo":null,"bst":413},{"dexNumber":21,"name":"Spearow","type1":"Normal","type2":"Flying","tier":"Common","evolvesTo":22,"bst":262},{"dexNumber":22,"name":"Fearow","type1":"Normal","type2":"Flying","tier":"Uncommon","evolvesTo":null,"bst":442},{"dexNumber":23,"name":"Ekans","type1":"Poison","type2":null,"tier":"Common","evolvesTo":24,"bst":288},{"dexNumber":24,"name":"Arbok","type1":"Poison","type2":null,"tier":"Uncommon","evolvesTo":null,"bst":438},{"dexNumber":25,"name":"Pikachu","type1":"Electric","type2":null,"tier":"Uncommon","evolvesTo":26,"bst":320},{"dexNumber":26,"name":"Raichu","type1":"Electric","type2":null,"tier":"Rare","evolvesTo":null,"bst":485},{"dexNumber":27,"name":"Sandshrew","type1":"Ground","type2":null,"tier":"Common","evolvesTo":28,"bst":300},{"dexNumber":28,"name":"Sandslash","type1":"Ground","type2":null,"tier":"Uncommon","evolvesTo":null,"bst":450},{"dexNumber":29,"name":"Nidoran-F","type1":"Poison","type2":null,"tier":"Common","evolvesTo":30,"bst":275},{"dexNumber":30,"name":"Nidorina","type1":"Poison","type2":null,"tier":"Common","evolvesTo":31,"bst":365},{"dexNumber":31,"name":"Nidoqueen","type1":"Poison","type2":"Ground","tier":"Uncommon","evolvesTo":null,"bst":505},{"dexNumber":32,"name":"Nidoran-M","type1":"Poison","type2":null,"tier":"Common","evolvesTo":33,"bst":273},{"dexNumber":33,"name":"Nidorino","type1":"Poison","type2":null,"tier":"Common","evolvesTo":34,"bst":365},{"dexNumber":34,"name":"Nidoking","type1":"Poison","type2":"Ground","tier":"Uncommon","evolvesTo":null,"bst":505},{"dexNumber":35,"name":"Clefairy","type1":"Normal","type2":null,"tier":"Uncommon","evolvesTo":36,"bst":323},{"dexNumber":36,"name":"Clefable","type1":"Normal","type2":null,"tier":"Rare","evolvesTo":null,"bst":483},{"dexNumber":37,"name":"Vulpix","type1":"Fire","type2":null,"tier":"Common","evolvesTo":38,"bst":299},{"dexNumber":38,"name":"Ninetales","type1":"Fire","type2":null,"tier":"Uncommon","evolvesTo":null,"bst":505},{"dexNumber":39,"name":"Jigglypuff","type1":"Normal","type2":null,"tier":"Common","evolvesTo":40,"bst":270},{"dexNumber":40,"name":"Wigglytuff","type1":"Normal","type2":null,"tier":"Uncommon","evolvesTo":null,"bst":435},{"dexNumber":41,"name":"Zubat","type1":"Poison","type2":"Flying","tier":"Common","evolvesTo":42,"bst":261},{"dexNumber":42,"name":"Golbat","type1":"Poison","type2":"Flying","tier":"Uncommon","evolvesTo":null,"bst":455},{"dexNumber":43,"name":"Oddish","type1":"Grass","type2":"Poison","tier":"Common","evolvesTo":44,"bst":270},{"dexNumber":44,"name":"Gloom","type1":"Grass","type2":"Poison","tier":"Common","evolvesTo":45,"bst":395},{"dexNumber":45,"name":"Vileplume","type1":"Grass","type2":"Poison","tier":"Uncommon","evolvesTo":null,"bst":490},{"dexNumber":46,"name":"Paras","type1":"Bug","type2":"Grass","tier":"Common","evolvesTo":47,"bst":285},{"dexNumber":47,"name":"Parasect","type1":"Bug","type2":"Grass","tier":"Uncommon","evolvesTo":null,"bst":495},{"dexNumber":48,"name":"Venonat","type1":"Bug","type2":"Poison","tier":"Common","evolvesTo":49,"bst":305},{"dexNumber":49,"name":"Venomoth","type1":"Bug","type2":"Poison","tier":"Uncommon","evolvesTo":null,"bst":450},{"dexNumber":50,"name":"Diglett","type1":"Ground","type2":null,"tier":"Common","evolvesTo":51,"bst":265},{"dexNumber":51,"name":"Dugtrio","type1":"Ground","type2":null,"tier":"Uncommon","evolvesTo":null,"bst":425},{"dexNumber":52,"name":"Meowth","type1":"Normal","type2":null,"tier":"Common","evolvesTo":53,"bst":290},{"dexNumber":53,"name":"Persian","type1":"Normal","type2":null,"tier":"Uncommon","evolvesTo":null,"bst":440},{"dexNumber":54,"name":"Psyduck","type1":"Water","type2":null,"tier":"Common","evolvesTo":55,"bst":320},{"dexNumber":55,"name":"Golduck","type1":"Water","type2":null,"tier":"Uncommon","evolvesTo":null,"bst":500},{"dexNumber":56,"name":"Mankey","type1":"Fighting","type2":null,"tier":"Common","evolvesTo":57,"bst":305},{"dexNumber":57,"name":"Primeape","type1":"Fighting","type2":null,"tier":"Uncommon","evolvesTo":null,"bst":455},{"dexNumber":58,"name":"Growlithe","type1":"Fire","type2":null,"tier":"Common","evolvesTo":59,"bst":350},{"dexNumber":59,"name":"Arcanine","type1":"Fire","type2":null,"tier":"Rare","evolvesTo":null,"bst":555},{"dexNumber":60,"name":"Poliwag","type1":"Water","type2":null,"tier":"Common","evolvesTo":61,"bst":300},{"dexNumber":61,"name":"Poliwhirl","type1":"Water","type2":null,"tier":"Common","evolvesTo":62,"bst":385},{"dexNumber":62,"name":"Poliwrath","type1":"Water","type2":"Fighting","tier":"Uncommon","evolvesTo":null,"bst":510},{"dexNumber":63,"name":"Abra","type1":"Psychic","type2":null,"tier":"Uncommon","evolvesTo":64,"bst":310},{"dexNumber":64,"name":"Kadabra","type1":"Psychic","type2":null,"tier":"Uncommon","evolvesTo":65,"bst":400},{"dexNumber":65,"name":"Alakazam","type1":"Psychic","type2":null,"tier":"Rare","evolvesTo":null,"bst":500},{"dexNumber":66,"name":"Machop","type1":"Fighting","type2":null,"tier":"Common","evolvesTo":67,"bst":305},{"dexNumber":67,"name":"Machoke","type1":"Fighting","type2":null,"tier":"Uncommon","evolvesTo":68,"bst":405},{"dexNumber":68,"name":"Machamp","type1":"Fighting","type2":null,"tier":"Rare","evolvesTo":null,"bst":505},{"dexNumber":69,"name":"Bellsprout","type1":"Grass","type2":"Poison","tier":"Common","evolvesTo":70,"bst":260},{"dexNumber":70,"name":"Weepinbell","type1":"Grass","type2":"Poison","tier":"Common","evolvesTo":71,"bst":390},{"dexNumber":71,"name":"Victreebel","type1":"Grass","type2":"Poison","tier":"Uncommon","evolvesTo":null,"bst":490},{"dexNumber":72,"name":"Tentacool","type1":"Water","type2":"Poison","tier":"Common","evolvesTo":73,"bst":335},{"dexNumber":73,"name":"Tentacruel","type1":"Water","type2":"Poison","tier":"Uncommon","evolvesTo":null,"bst":515},{"dexNumber":74,"name":"Geodude","type1":"Rock","type2":"Ground","tier":"Common","evolvesTo":75,"bst":300},{"dexNumber":75,"name":"Graveler","type1":"Rock","type2":"Ground","tier":"Common","evolvesTo":76,"bst":390},{"dexNumber":76,"name":"Golem","type1":"Rock","type2":"Ground","tier":"Uncommon","evolvesTo":null,"bst":495},{"dexNumber":77,"name":"Ponyta","type1":"Fire","type2":null,"tier":"Common","evolvesTo":78,"bst":410},{"dexNumber":78,"name":"Rapidash","type1":"Fire","type2":null,"tier":"Uncommon","evolvesTo":null,"bst":500},{"dexNumber":79,"name":"Slowpoke","type1":"Water","type2":"Psychic","tier":"Common","evolvesTo":80,"bst":315},{"dexNumber":80,"name":"Slowbro","type1":"Water","type2":"Psychic","tier":"Uncommon","evolvesTo":null,"bst":490},{"dexNumber":81,"name":"Magnemite","type1":"Electric","type2":null,"tier":"Common","evolvesTo":82,"bst":325},{"dexNumber":82,"name":"Magneton","type1":"Electric","type2":null,"tier":"Uncommon","evolvesTo":null,"bst":465},{"dexNumber":83,"name":"Farfetch'd","type1":"Normal","type2":"Flying","tier":"Uncommon","evolvesTo":null,"bst":352},{"dexNumber":84,"name":"Doduo","type1":"Normal","type2":"Flying","tier":"Common","evolvesTo":85,"bst":310},{"dexNumber":85,"name":"Dodrio","type1":"Normal","type2":"Flying","tier":"Uncommon","evolvesTo":null,"bst":500},{"dexNumber":86,"name":"Seel","type1":"Water","type2":null,"tier":"Common","evolvesTo":87,"bst":325},{"dexNumber":87,"name":"Dewgong","type1":"Water","type2":"Ice","tier":"Uncommon","evolvesTo":null,"bst":475},{"dexNumber":88,"name":"Grimer","type1":"Poison","type2":null,"tier":"Common","evolvesTo":89,"bst":325},{"dexNumber":89,"name":"Muk","type1":"Poison","type2":null,"tier":"Uncommon","evolvesTo":null,"bst":500},{"dexNumber":90,"name":"Shellder","type1":"Water","type2":null,"tier":"Common","evolvesTo":91,"bst":305},{"dexNumber":91,"name":"Cloyster","type1":"Water","type2":"Ice","tier":"Uncommon","evolvesTo":null,"bst":525},{"dexNumber":92,"name":"Gastly","type1":"Ghost","type2":"Poison","tier":"Common","evolvesTo":93,"bst":310},{"dexNumber":93,"name":"Haunter","type1":"Ghost","type2":"Poison","tier":"Uncommon","evolvesTo":94,"bst":425},{"dexNumber":94,"name":"Gengar","type1":"Ghost","type2":"Poison","tier":"Rare","evolvesTo":null,"bst":500},{"dexNumber":95,"name":"Onix","type1":"Rock","type2":"Ground","tier":"Uncommon","evolvesTo":null,"bst":385},{"dexNumber":96,"name":"Drowzee","type1":"Psychic","type2":null,"tier":"Common","evolvesTo":97,"bst":328},{"dexNumber":97,"name":"Hypno","type1":"Psychic","type2":null,"tier":"Uncommon","evolvesTo":null,"bst":448},{"dexNumber":98,"name":"Krabby","type1":"Water","type2":null,"tier":"Common","evolvesTo":99,"bst":340},{"dexNumber":99,"name":"Kingler","type1":"Water","type2":null,"tier":"Uncommon","evolvesTo":null,"bst":475},{"dexNumber":100,"name":"Voltorb","type1":"Electric","type2":null,"tier":"Common","evolvesTo":101,"bst":320},{"dexNumber":101,"name":"Electrode","type1":"Electric","type2":null,"tier":"Uncommon","evolvesTo":null,"bst":490},{"dexNumber":102,"name":"Exeggcute","type1":"Grass","type2":"Psychic","tier":"Common","evolvesTo":103,"bst":395},{"dexNumber":103,"name":"Exeggutor","type1":"Grass","type2":"Psychic","tier":"Rare","evolvesTo":null,"bst":520},{"dexNumber":104,"name":"Cubone","type1":"Ground","type2":null,"tier":"Common","evolvesTo":105,"bst":320},{"dexNumber":105,"name":"Marowak","type1":"Ground","type2":null,"tier":"Uncommon","evolvesTo":null,"bst":485},{"dexNumber":106,"name":"Hitmonlee","type1":"Fighting","type2":null,"tier":"Rare","evolvesTo":null,"bst":455},{"dexNumber":107,"name":"Hitmonchan","type1":"Fighting","type2":null,"tier":"Rare","evolvesTo":null,"bst":455},{"dexNumber":108,"name":"Lickitung","type1":"Normal","type2":null,"tier":"Uncommon","evolvesTo":null,"bst":355},{"dexNumber":109,"name":"Koffing","type1":"Poison","type2":null,"tier":"Common","evolvesTo":110,"bst":355},{"dexNumber":110,"name":"Weezing","type1":"Poison","type2":null,"tier":"Uncommon","evolvesTo":null,"bst":500},{"dexNumber":111,"name":"Rhyhorn","type1":"Ground","type2":"Rock","tier":"Common","evolvesTo":112,"bst":345},{"dexNumber":112,"name":"Rhydon","type1":"Ground","type2":"Rock","tier":"Uncommon","evolvesTo":null,"bst":485},{"dexNumber":113,"name":"Chansey","type1":"Normal","type2":null,"tier":"Rare","evolvesTo":null,"bst":450},{"dexNumber":114,"name":"Tangela","type1":"Grass","type2":null,"tier":"Uncommon","evolvesTo":null,"bst":345},{"dexNumber":115,"name":"Kangaskhan","type1":"Normal","type2":null,"tier":"Rare","evolvesTo":null,"bst":490},{"dexNumber":116,"name":"Horsea","type1":"Water","type2":null,"tier":"Common","evolvesTo":117,"bst":295},{"dexNumber":117,"name":"Seadra","type1":"Water","type2":null,"tier":"Uncommon","evolvesTo":null,"bst":440},{"dexNumber":118,"name":"Goldeen","type1":"Water","type2":null,"tier":"Common","evolvesTo":119,"bst":320},{"dexNumber":119,"name":"Seaking","type1":"Water","type2":null,"tier":"Uncommon","evolvesTo":null,"bst":460},{"dexNumber":120,"name":"Staryu","type1":"Water","type2":null,"tier":"Common","evolvesTo":121,"bst":340},{"dexNumber":121,"name":"Starmie","type1":"Water","type2":"Psychic","tier":"Rare","evolvesTo":null,"bst":500},{"dexNumber":122,"name":"Mr. Mime","type1":"Psychic","type2":null,"tier":"Uncommon","evolvesTo":null,"bst":395},{"dexNumber":123,"name":"Scyther","type1":"Bug","type2":"Flying","tier":"Rare","evolvesTo":null,"bst":500},{"dexNumber":124,"name":"Jynx","type1":"Ice","type2":"Psychic","tier":"Uncommon","evolvesTo":null,"bst":455},{"dexNumber":125,"name":"Electabuzz","type1":"Electric","type2":null,"tier":"Rare","evolvesTo":null,"bst":473},{"dexNumber":126,"name":"Magmar","type1":"Fire","type2":null,"tier":"Rare","evolvesTo":null,"bst":473},{"dexNumber":127,"name":"Pinsir","type1":"Bug","type2":null,"tier":"Rare","evolvesTo":null,"bst":500},{"dexNumber":128,"name":"Tauros","type1":"Normal","type2":null,"tier":"Rare","evolvesTo":null,"bst":490},{"dexNumber":129,"name":"Magikarp","type1":"Water","type2":null,"tier":"Common","evolvesTo":130,"bst":200},{"dexNumber":130,"name":"Gyarados","type1":"Water","type2":"Flying","tier":"Rare","evolvesTo":null,"bst":540},{"dexNumber":131,"name":"Lapras","type1":"Water","type2":"Ice","tier":"Rare","evolvesTo":null,"bst":535},{"dexNumber":132,"name":"Ditto","type1":"Normal","type2":null,"tier":"Uncommon","evolvesTo":null,"bst":288},{"dexNumber":133,"name":"Eevee","type1":"Normal","type2":null,"tier":"Uncommon","evolvesTo":136,"bst":325},{"dexNumber":134,"name":"Vaporeon","type1":"Water","type2":null,"tier":"Rare","evolvesTo":null,"bst":525},{"dexNumber":135,"name":"Jolteon","type1":"Electric","type2":null,"tier":"Rare","evolvesTo":null,"bst":525},{"dexNumber":136,"name":"Flareon","type1":"Fire","type2":null,"tier":"Rare","evolvesTo":null,"bst":525},{"dexNumber":137,"name":"Porygon","type1":"Normal","type2":null,"tier":"Rare","evolvesTo":null,"bst":395},{"dexNumber":138,"name":"Omanyte","type1":"Rock","type2":"Water","tier":"Uncommon","evolvesTo":139,"bst":355},{"dexNumber":139,"name":"Omastar","type1":"Rock","type2":"Water","tier":"Rare","evolvesTo":null,"bst":495},{"dexNumber":140,"name":"Kabuto","type1":"Rock","type2":"Water","tier":"Uncommon","evolvesTo":141,"bst":355},{"dexNumber":141,"name":"Kabutops","type1":"Rock","type2":"Water","tier":"Rare","evolvesTo":null,"bst":500},{"dexNumber":142,"name":"Aerodactyl","type1":"Rock","type2":"Flying","tier":"Rare","evolvesTo":null,"bst":515},{"dexNumber":143,"name":"Snorlax","type1":"Normal","type2":null,"tier":"Rare","evolvesTo":null,"bst":590},{"dexNumber":144,"name":"Articuno","type1":"Ice","type2":"Flying","tier":"Rare","evolvesTo":null,"bst":580},{"dexNumber":145,"name":"Zapdos","type1":"Electric","type2":"Flying","tier":"Rare","evolvesTo":null,"bst":580},{"dexNumber":146,"name":"Moltres","type1":"Fire","type2":"Flying","tier":"Rare","evolvesTo":null,"bst":580},{"dexNumber":147,"name":"Dratini","type1":"Dragon","type2":null,"tier":"Uncommon","evolvesTo":148,"bst":300},{"dexNumber":148,"name":"Dragonair","type1":"Dragon","type2":null,"tier":"Rare","evolvesTo":149,"bst":420},{"dexNumber":149,"name":"Dragonite","type1":"Dragon","type2":"Flying","tier":"Rare","evolvesTo":null,"bst":600},{"dexNumber":150,"name":"Mewtwo","type1":"Psychic","type2":null,"tier":"Rare","evolvesTo":null,"bst":680},{"dexNumber":151,"name":"Mew","type1":"Psychic","type2":null,"tier":"Rare","evolvesTo":null,"bst":600}];

const INLINE_TYPECHART = {
  "Normal":    {"Rock":0.5,"Ghost":0},
  "Fire":      {"Fire":0.5,"Water":0.5,"Grass":2,"Ice":2,"Bug":2,"Rock":0.5,"Dragon":0.5},
  "Water":     {"Fire":2,"Water":0.5,"Grass":0.5,"Ground":2,"Rock":2,"Dragon":0.5},
  "Electric":  {"Water":2,"Electric":0.5,"Grass":0.5,"Ground":0,"Flying":2,"Dragon":0.5},
  "Grass":     {"Fire":0.5,"Water":2,"Grass":0.5,"Poison":0.5,"Ground":2,"Flying":0.5,"Bug":0.5,"Rock":2,"Dragon":0.5},
  "Ice":       {"Water":0.5,"Grass":2,"Ice":0.5,"Ground":2,"Flying":2,"Dragon":2},
  "Fighting":  {"Normal":2,"Ice":2,"Poison":0.5,"Flying":0.5,"Psychic":0.5,"Bug":0.5,"Rock":2,"Ghost":0},
  "Poison":    {"Grass":2,"Poison":0.5,"Ground":0.5,"Bug":2,"Rock":0.5,"Ghost":0.5},
  "Ground":    {"Fire":2,"Electric":2,"Grass":0.5,"Poison":2,"Flying":0,"Bug":0.5,"Rock":2},
  "Flying":    {"Electric":0.5,"Grass":2,"Fighting":2,"Bug":2,"Rock":0.5},
  "Psychic":   {"Fighting":2,"Poison":2,"Psychic":0.5,"Ghost":0},
  "Bug":       {"Fire":0.5,"Grass":2,"Fighting":0.5,"Flying":0.5,"Psychic":2,"Ghost":0.5,"Poison":2},
  "Rock":      {"Fire":2,"Ice":2,"Fighting":0.5,"Ground":0.5,"Flying":2,"Bug":2},
  "Ghost":     {"Normal":0,"Psychic":0,"Ghost":2},
  "Dragon":    {"Dragon":2}
};

const INLINE_STAGES = [
  {"id":"gym1","stageName":"Brock's Gym","stageKind":"GYM","stageTypes":["Rock"],"leader":"Brock","badge":"Boulder Badge"},
  {"id":"gym2","stageName":"Misty's Gym","stageKind":"GYM","stageTypes":["Water"],"leader":"Misty","badge":"Cascade Badge"},
  {"id":"gym3","stageName":"Lt. Surge's Gym","stageKind":"GYM","stageTypes":["Electric"],"leader":"Lt. Surge","badge":"Thunder Badge"},
  {"id":"gym4","stageName":"Erika's Gym","stageKind":"GYM","stageTypes":["Grass"],"leader":"Erika","badge":"Rainbow Badge"},
  {"id":"gym5","stageName":"Koga's Gym","stageKind":"GYM","stageTypes":["Poison"],"leader":"Koga","badge":"Soul Badge"},
  {"id":"gym6","stageName":"Sabrina's Gym","stageKind":"GYM","stageTypes":["Psychic"],"leader":"Sabrina","badge":"Marsh Badge"},
  {"id":"gym7","stageName":"Blaine's Gym","stageKind":"GYM","stageTypes":["Fire"],"leader":"Blaine","badge":"Volcano Badge"},
  {"id":"gym8","stageName":"Giovanni's Gym","stageKind":"GYM","stageTypes":["Ground"],"leader":"Giovanni","badge":"Earth Badge"},
  {"id":"e4_1","stageName":"Lorelei — Elite Four","stageKind":"E4","stageTypes":["Ice","Water"],"leader":"Lorelei","badge":null},
  {"id":"e4_2","stageName":"Bruno — Elite Four","stageKind":"E4","stageTypes":["Fighting","Rock"],"leader":"Bruno","badge":null},
  {"id":"e4_3","stageName":"Agatha — Elite Four","stageKind":"E4","stageTypes":["Ghost","Poison"],"leader":"Agatha","badge":null},
  {"id":"e4_4","stageName":"Lance — Elite Four","stageKind":"E4","stageTypes":["Dragon","Flying"],"leader":"Lance","badge":null},
  {"id":"champion","stageName":"Blue — Champion","stageKind":"CHAMPION","stageTypes":["Mixed"],"leader":"Blue","badge":null}
];

const INLINE_BALANCE = {"intermissionWheel":{"Capture":30,"DoubleCapture":10,"GuaranteedRareEncounter":6,"MysteryPokemon":9,"EvolvePartyPokemon":12,"TypeShield":10,"LuckyCharm":6,"BonusSlotNextBattle":7,"FindItem":10},"captureTierWeights":{"Common":70,"Uncommon":25,"Rare":5},"mysteryTierWeights":{"Common":55,"Uncommon":35,"Rare":10},"captureResultWeights":{"Fail":30,"Success":60,"Critical":10},"criticalBonus":6,"partyFullWheel":{"ReplaceRandom":40,"ReplaceWorstMatchup":40,"DiscardNew":20},"findItemWheel":{"Potion":45,"TypeShield":30,"LuckyCharm":20,"RunningShoes":5},"intermissionSpins":{"base":1,"withRunningShoes":2},"typeShieldBonus":8,"bonusSlotContribution":7,"winModel":{"baseChance":10,"bstFormula":{"k":0.11737,"b":2.7},"stageContributionMultiplier":{"multEarly":1.0,"multLate":0.13},"clampMin":5,"clampMax":95}};

// ── Global State ──────────────────────────────────────────────
let G = {};
let DATA = {};

// ── Data Init ─────────────────────────────────────────────────
function loadData() {
  DATA.pokedex = INLINE_POKEDEX;
  DATA.typeChart = INLINE_TYPECHART;
  DATA.stages = INLINE_STAGES;
  DATA.balance = INLINE_BALANCE;
  DATA.byTier = { Common: [], Uncommon: [], Rare: [] };
  for (const p of DATA.pokedex) DATA.byTier[p.tier].push(p);
  DATA.dexMap = {};
  for (const p of DATA.pokedex) DATA.dexMap[p.dexNumber] = p;
}

// ── Wheel Engine ───────────────────────────────────────────────
const canvas = document.getElementById('wheel-canvas');
const ctx = canvas.getContext('2d');

const WHEEL_COLORS_DARK = [
  '#c03060','#e06020','#b8a020','#208050','#2060c0','#803090',
  '#c05050','#2090a0','#a04080','#50a030','#d04030','#3060a0',
  '#a07020','#306090'
];
const WHEEL_COLORS_LIGHT = [
  '#f06090','#f0a060','#d8c040','#60c080','#6090e0','#c070d0',
  '#e08080','#60c0d0','#d070a0','#80d070','#f07060','#6080d0',
  '#d0a040','#5080d0'
];

let wheelState = {
  slices: [],
  angle: 0,
  spinning: false,
  targetAngle: 0,
  startAngle: 0,
  startTime: 0,
  duration: 0,
  onDone: null,
};

function buildWheel(slices) {
  const isDark = document.documentElement.getAttribute('data-theme') !== 'light';
  const colors = isDark ? WHEEL_COLORS_DARK : WHEEL_COLORS_LIGHT;
  return slices.map((s, i) => ({ ...s, color: colors[i % colors.length] }));
}

// Returns the label of the slice currently under the pointer (top of wheel).
// The pointer is at the top, which corresponds to angle=0 in draw coords.
// draw: slices start at (wheelAngle - PI/2). Pointer at top = absolute angle -PI/2 from center.
// The slice at the pointer is whichever slice contains angle 0 (top) in the rotated wheel.
function getPointerSlice(slices, angle) {
  if (!slices || slices.length === 0) return null;
  const total = slices.reduce((s, x) => s + x.weight, 0);
  // "top" in our coordinate: the pointer sits at angle = -(PI/2) + angle relative to draw start
  // Slices are drawn starting at (angle - PI/2), going clockwise.
  // The pointer is at the top = angle (- PI/2) in absolute terms.
  // We need to find which slice contains the pointer position.
  // Normalize: pointer position within wheel = 0 (start of first slice reference angle)
  // pointer is at the draw start angle = angle - PI/2
  // So relative to draw start (angle - PI/2), pointer is at 0.
  // But we want offset from angle=0 (the draw start of first slice at offset angle - PI/2)
  // Actually simpler: the pointer is at the top. The wheel's reference angle rotates.
  // At angle=0, slice[0] starts at -PI/2 (top). So pointer hits slice[0]'s start.
  // pointer position in "slice space": we need (0 - (angle - PI/2)) mod 2PI = (PI/2 - angle) mod 2PI
  // = how far into the wheel (clockwise from its start) the pointer sits
  let pointerInWheel = ((Math.PI / 2 - angle) % (2 * Math.PI) + 2 * Math.PI) % (2 * Math.PI);
  let acc = 0;
  for (const s of slices) {
    const sweep = (s.weight / total) * 2 * Math.PI;
    if (pointerInWheel < acc + sweep) return s;
    acc += sweep;
  }
  return slices[slices.length - 1];
}

function drawWheel(slices, angle) {
  const W = canvas.width, H = canvas.height;
  const cx = W / 2, cy = H / 2;
  const r = Math.min(W, H) / 2 - 6;
  ctx.clearRect(0, 0, W, H);
  if (!slices || slices.length === 0) return;

  let start = angle - Math.PI / 2;
  const total = slices.reduce((s, x) => s + x.weight, 0);

  for (const s of slices) {
    const sweep = (s.weight / total) * 2 * Math.PI;
    const end = start + sweep;
    const mid = start + sweep / 2;

    ctx.beginPath();
    ctx.moveTo(cx, cy);
    ctx.arc(cx, cy, r, start, end);
    ctx.closePath();
    ctx.fillStyle = s.color;
    ctx.fill();
    ctx.strokeStyle = '#000';
    ctx.lineWidth = 1.5;
    ctx.stroke();

    if (sweep > 0.12) {
      ctx.save();
      ctx.translate(cx, cy);
      ctx.rotate(mid);
      ctx.textAlign = 'right';
      ctx.textBaseline = 'middle';
      const isDark = document.documentElement.getAttribute('data-theme') !== 'light';
      ctx.fillStyle = isDark ? '#fff' : '#000';
      ctx.shadowColor = isDark ? '#000' : '#fff';
      ctx.shadowBlur = 4;
      let label = s.label.length > 14 ? s.label.slice(0, 13) + '\u2026' : s.label;
      const fontSize = Math.max(8, Math.min(13, sweep * 40));
      ctx.font = `bold ${fontSize}px 'VT323', monospace`;
      ctx.fillText(label, r * 0.65, 0);
      ctx.restore();
    }
    start = end;
  }

  // Center hub
  ctx.beginPath();
  ctx.arc(cx, cy, 18, 0, 2 * Math.PI);
  ctx.fillStyle = '#111';
  ctx.fill();
  ctx.strokeStyle = '#f8e71c';
  ctx.lineWidth = 2;
  ctx.stroke();
}

function easeOut(t) { return 1 - Math.pow(1 - t, 3); }

function animateSpin(timestamp) {
  if (!wheelState.spinning) return;
  const elapsed = timestamp - wheelState.startTime;
  const progress = Math.min(elapsed / wheelState.duration, 1);
  wheelState.angle = wheelState.startAngle + (wheelState.targetAngle - wheelState.startAngle) * easeOut(progress);
  drawWheel(wheelState.slices, wheelState.angle);
  const cur = getPointerSlice(wheelState.slices, wheelState.angle);
  if (cur) setPointerLabel(cur.label);
  if (progress < 1) {
    requestAnimationFrame(animateSpin);
  } else {
    wheelState.angle = wheelState.targetAngle;
    drawWheel(wheelState.slices, wheelState.angle);
    wheelState.spinning = false;
    canvas.classList.remove('wheel-spinning');
    if (wheelState.onDone) wheelState.onDone();
  }
}

function getPointerSlice(slices, angle) {
  if (!slices || slices.length === 0) return null;
  const total = slices.reduce((s, x) => s + x.weight, 0);
  // Pointer at top: pointerInWheel = (-angle) mod 2PI
  let p = ((-angle) % (2 * Math.PI) + 2 * Math.PI) % (2 * Math.PI);
  let acc = 0;
  for (const s of slices) {
    const sweep = (s.weight / total) * 2 * Math.PI;
    if (p < acc + sweep) return s;
    acc += sweep;
  }
  return slices[slices.length - 1];
}

function setPointerLabel(text) {
  const el = document.getElementById('pointer-label');
  if (el) el.textContent = text ? '▼  ' + text : '';
}

function showResultPopup(label, cb) {
  const popup = document.getElementById('spin-popup');
  const lbl   = document.getElementById('spin-popup-label');
  if (!popup || !lbl) { if (cb) cb(); return; }
  lbl.textContent = label;
  popup.classList.remove('hidden');
  let dismissed = false;
  function dismiss() {
    if (dismissed) return;
    dismissed = true;
    popup.classList.add('hidden');
    popup.removeEventListener('click', dismiss);
    if (cb) cb();
  }
  popup.addEventListener('click', dismiss);
  setTimeout(dismiss, 1400);
}

function spinWheel(slices, onDone) {
  if (wheelState.spinning) return;
  if (!slices || slices.length === 0) return;

  const built = buildWheel(slices);
  wheelState.slices = built;

  // Pick winner by weighted random
  const total = slices.reduce((s, x) => s + x.weight, 0);
  let r = Math.random() * total;
  let winnerIdx = slices.length - 1;
  for (let i = 0; i < slices.length; i++) {
    r -= slices[i].weight;
    if (r <= 0) { winnerIdx = i; break; }
  }

  // Target angle: center of winner slice lands at pointer (top)
  // getPointerSlice: pointerInWheel = (-angle) mod 2PI
  // We want pointerInWheel = winnerMid => angle = -winnerMid (mod 2PI)
  let accAngle = 0;
  for (let i = 0; i < winnerIdx; i++) accAngle += (slices[i].weight / total) * 2 * Math.PI;
  const winnerMid = accAngle + (slices[winnerIdx].weight / total) * Math.PI;

  const targetNorm   = ((-winnerMid) % (2 * Math.PI) + 2 * Math.PI) % (2 * Math.PI);
  const currentNorm  = ((wheelState.angle % (2 * Math.PI)) + 2 * Math.PI) % (2 * Math.PI);
  const spins = 4 + Math.random() * 4;
  let diff = (targetNorm - currentNorm + 2 * Math.PI) % (2 * Math.PI);
  if (diff < 0.05) diff += 2 * Math.PI;

  wheelState.targetAngle = wheelState.angle + spins * 2 * Math.PI + diff;
  wheelState.startAngle  = wheelState.angle;
  wheelState.spinning    = true;
  wheelState.startTime   = performance.now();
  wheelState.duration    = 2800 + Math.random() * 1000;
  wheelState.onDone = () => {
    wheelState.angle = wheelState.targetAngle; // snap — no float drift
    const finalSlice = getPointerSlice(built, wheelState.angle);
    const winner = finalSlice || built[winnerIdx];
    const finalIdx = built.indexOf(winner);
    setPointerLabel(winner.label);
    showResultPopup(winner.label, () => onDone(finalIdx, winner));
  };
  canvas.classList.add('wheel-spinning');
  requestAnimationFrame(animateSpin);
}

// ── Pointer Label ──────────────────────────────────────────────
function setPointerLabel(text) {
  document.getElementById('pointer-label').textContent = text ? `▼  ${text}` : '';
}

// ── Type Effectiveness ─────────────────────────────────────────
function getEffectiveness(attackType, defType) {
  const row = DATA.typeChart[attackType];
  if (!row) return 1;
  return row[defType] ?? 1;
}

function getStageContributionMultiplier(stageIndex) {
  const sm = DATA.balance.winModel.stageContributionMultiplier;
  const total = DATA.stages.length;
  const t = total > 1 ? stageIndex / (total - 1) : 0;
  return sm.multEarly + (sm.multLate - sm.multEarly) * t;
}

function getPokemonMatchup(pokemon, stageTypes, stageIndex) {
  // BST-based contribution: bst * 0.11737 + 2.7, then scaled by stage multiplier
  const bst = pokemon.bst || 300; // fallback if missing
  const baseContrib = bst * 0.11737 + 2.7;
  const mult = (stageIndex !== undefined) ? getStageContributionMultiplier(stageIndex) : 1.0;
  const value = Math.max(1, Math.round(baseContrib * mult));
  // Category kept for display only (no longer affects value)
  const pokemonTypes = [pokemon.type1, pokemon.type2].filter(Boolean);
  const filtered = stageTypes.filter(t => t !== 'Mixed');
  let best = 0, superCount = 0;
  for (const pt of pokemonTypes) {
    for (const st of filtered) {
      const eff = getEffectiveness(pt, st);
      if (eff > best) best = eff;
      if (eff >= 2) superCount++;
    }
  }
  let category;
  if (superCount >= 2) category = 'VeryStrong';
  else if (best >= 2)  category = 'Strong';
  else if (best >= 1)  category = 'Neutral';
  else                 category = 'Resisted';

  return { category, baseContrib: Math.round(baseContrib), bst, mult: +mult.toFixed(3), value };
}

function computeWinChance(party, stageTypes, bonuses = [], stage = null) {
  const wm = DATA.balance.winModel;
  const stageIndex = stage ? DATA.stages.indexOf(stage) : 0;
  let rawChance = wm.baseChance;
  const breakdown = [];
  let pokemonContribSum = 0;

  for (const p of party) {
    const m = getPokemonMatchup(p, stageTypes, stageIndex);
    rawChance += m.value;
    pokemonContribSum += m.value;
    breakdown.push({ name: p.name, category: m.category, baseContrib: m.baseContrib,
                     mult: m.mult, statFactor: m.statFactor, value: m.value, kind: 'pokemon' });
  }

  for (const b of bonuses) {
    rawChance += b.value;
    breakdown.push({ name: b.label, category: b.category, value: b.value, kind: 'bonus' });
  }

  const difficulty = stage ? (stage.difficulty || 0) : 0;

  let jitter = 0;
  if (stage && stage.jitter && stage.jitter.enabled) {
    if (G.stageJitter && G.stageJitter[stage.id] !== undefined) {
      jitter = G.stageJitter[stage.id];
    } else {
      const { min, max } = stage.jitter;
      jitter = Math.round(min + Math.random() * (max - min));
      if (G.stageJitter) G.stageJitter[stage.id] = jitter;
    }
  }

  const finalChance = Math.max(wm.clampMin, Math.min(wm.clampMax, rawChance - difficulty + jitter));
  return { chance: finalChance, rawChance, pokemonContribSum, difficulty, jitter, breakdown, stageIndex };
}

// ── Spin Queue — manual player-driven sub-spins ────────────────
// Each item: { slices, label, onResult(winnerIdx, slice, cb) }
// Player presses SPIN for every step. Between steps we show a prompt.
let _spinQueue = [];
let _onQueueDone = null;

function enqueueSpins(steps, onAllDone) {
  _spinQueue = [...steps];
  _onQueueDone = onAllDone;
  advanceQueue();
}

function advanceQueue() {
  if (_spinQueue.length === 0) {
    if (_onQueueDone) _onQueueDone();
    return;
  }
  const step = _spinQueue.shift();
  setWheelResult(step.prompt || 'Spin!');
  setPointerLabel('');
  drawWheel(buildWheel(step.slices), wheelState.angle);
  // Pre-draw so player sees the wheel before spinning
  wheelState.slices = buildWheel(step.slices);
  drawWheel(wheelState.slices, wheelState.angle);

  setSpinHandler(() => {
    spinWheel(step.slices, (idx, slice) => {
      step.onResult(idx, slice, () => {
        renderAll();
        advanceQueue();
      });
    });
  });
}

// ── Game Init ──────────────────────────────────────────────────
function initGame() {
  G = {
    phase: 'STARTER',
    stageIndex: 0,
    party: [],
    inventory: { Potion: 0, LuckyCharm: 0, TypeShield: 0, RunningShoes: false },
    bonuses: { criticalBonus: false, bonusSlot: null },
    intermissionSpinsLeft: 0,
    runEnded: false,
    stageJitter: {},
  };
  _spinQueue = [];
  _onQueueDone = null;
  document.getElementById('run-log').innerHTML = '';
  setPointerLabel('');
  renderAll();
  drawWheel([], 0);
  setupStarterWheel();
}

// ── Starter ────────────────────────────────────────────────────
function setupStarterWheel() {
  const starters = [DATA.dexMap[1], DATA.dexMap[4], DATA.dexMap[7]];
  const slices = starters.map(p => ({ label: p.name, weight: 1 }));
  setPhaseLabel('Starter Selection', 'Who will you choose?');
  setWheelResult('Spin to choose your starter!');
  setPointerLabel('');
  wheelState.slices = buildWheel(slices);
  drawWheel(wheelState.slices, wheelState.angle);

  setSpinHandler(() => {
    spinWheel(slices, (idx) => {
      const chosen = starters[idx];
      log('\u2728', `Starter: ${chosen.name}!`, 'log-capture');
      G.party.push({ ...chosen });
      G.phase = 'INTERMISSION';
      G.stageIndex = 0;
      G.intermissionSpinsLeft = getIntermissionSpins();
      setWheelResult(`${chosen.name} is your starter!`);
      renderAll();
      setupIntermissionWheel();
    });
  });
}

// ── Intermission ───────────────────────────────────────────────
function getIntermissionSpins() {
  return G.inventory.RunningShoes
    ? DATA.balance.intermissionSpins.withRunningShoes
    : DATA.balance.intermissionSpins.base;
}

function setupIntermissionWheel() {
  if (G.intermissionSpinsLeft <= 0) {
    setupBattlePhase();
    return;
  }
  const stage = DATA.stages[G.stageIndex];
  setPhaseLabel('Intermission', `Before: ${stage.stageName}`);
  updateSpinQueueLabel();

  const bw = DATA.balance.intermissionWheel;
  const slices = Object.entries(bw).map(([key, w]) => ({
    label: formatActionLabel(key), weight: w, action: key
  }));
  wheelState.slices = buildWheel(slices);
  drawWheel(wheelState.slices, wheelState.angle);
  setWheelResult('Spin the intermission wheel!');
  setPointerLabel('');

  setSpinHandler(() => {
    spinWheel(slices, (idx, slice) => {
      G.intermissionSpinsLeft--;
      updateSpinQueueLabel();
      log('\u1F3A1', `Action: ${slice.label}`, 'log-info');
      setWheelResult(`${slice.label}`);
      resolveIntermissionAction(slice.action, () => {
        renderAll();
        // After action done, setup next intermission spin or go to battle
        setupIntermissionWheel();
      });
    });
  });
}

function formatActionLabel(key) {
  return {
    Capture: 'Capture!', DoubleCapture: 'x2 Capture!',
    GuaranteedRareEncounter: 'Rare!', MysteryPokemon: 'Mystery!',
    EvolvePartyPokemon: 'Evolve!', TypeShield: 'Type Shield!',
    LuckyCharm: 'Lucky Charm!', BonusSlotNextBattle: 'Bonus Slot!',
    FindItem: 'Find Item!',
  }[key] || key;
}

function updateSpinQueueLabel() {
  const el = document.getElementById('spin-queue-label');
  el.textContent = G.phase === 'INTERMISSION' ? `Intermission spins left: ${G.intermissionSpinsLeft}` : '';
}

// ── Action Resolver ────────────────────────────────────────────
function resolveIntermissionAction(action, cb) {
  switch(action) {
    case 'Capture':
      doCapture(false, false, cb); break;
    case 'DoubleCapture':
      log('\u1F3A3', 'Double Capture! First capture...', 'log-capture');
      doCapture(false, false, () => {
        log('\u1F3A3', 'Double Capture! Second capture...', 'log-capture');
        doCapture(false, false, cb);
      });
      break;
    case 'GuaranteedRareEncounter':
      doCapture(true, false, cb); break;
    case 'MysteryPokemon':
      doCapture(false, true, cb); break;
    case 'EvolvePartyPokemon':
      doEvolve(cb); break;
    case 'TypeShield':
      G.inventory.TypeShield++;
      log('\u1F6E1', 'Type Shield added to bag!', 'log-item');
      cb(); break;
    case 'LuckyCharm':
      G.inventory.LuckyCharm++;
      log('\u1F340', 'Lucky Charm added to bag!', 'log-item');
      cb(); break;
    case 'BonusSlotNextBattle':
      doBonusSlot(cb); break;
    case 'FindItem':
      doFindItem(cb); break;
    default: cb();
  }
}

// ── Capture — fully manual sub-spins ──────────────────────────
function doCapture(forceRare, mystery, cb) {
  const steps = [];

  if (forceRare) {
    log('\u2B50', 'Guaranteed Rare Encounter! Spin to pick the Pokemon.', 'log-capture');
    const pool = DATA.byTier['Rare'];
    steps.push({
      prompt: '\u2B50 Spin to pick the Rare Pokemon!',
      slices: pool.map(p => ({ label: p.name, weight: 1 })),
      onResult(idx, slice, next) {
        const caught = pool[idx];
        log('\u1F3B0', `Rare encounter: ${caught.name}`, 'log-capture');
        pushCaptureResultStep(steps, caught, cb);
        next();
      }
    });
  } else if (mystery) {
    log('\u2753', 'Mystery Pokemon! Spin the tier.', 'log-capture');
    const mw = DATA.balance.mysteryTierWeights;
    steps.push({
      prompt: '\u2753 Mystery Pokemon — Spin the tier!',
      slices: Object.entries(mw).map(([t, w]) => ({ label: t, weight: w, tier: t })),
      onResult(idx, slice, next) {
        const tier = slice.tier;
        log('\u1F3A1', `Mystery tier: ${tier}`, 'log-capture');
        const pool = DATA.byTier[tier];
        // Inject Pokemon step at front of remaining queue
        _spinQueue.unshift({
          prompt: `\u2753 Spin to pick the ${tier} Pokemon!`,
          slices: pool.map(p => ({ label: p.name, weight: 1 })),
          onResult(idx2, slice2, next2) {
            const caught = pool[idx2];
            log('\u1F3B0', `Mystery: ${caught.name}`, 'log-capture');
            // Inject result step
            _spinQueue.unshift(makeCaptureResultStep(caught, cb));
            next2();
          }
        });
        next();
      }
    });
  } else {
    // Standard: Tier → Pokemon → Result
    log('\u1F3A3', 'Capture! Spin the tier.', 'log-capture');
    const tw = DATA.balance.captureTierWeights;
    steps.push({
      prompt: '\u1F3A3 Capture — Spin the tier!',
      slices: Object.entries(tw).map(([t, w]) => ({ label: t, weight: w, tier: t })),
      onResult(idx, slice, next) {
        const tier = slice.tier;
        log('\u1F3A1', `Tier: ${tier}`, 'log-capture');
        const pool = DATA.byTier[tier];
        _spinQueue.unshift({
          prompt: `\u1F3A3 Spin to pick the ${tier} Pokemon!`,
          slices: pool.map(p => ({ label: p.name, weight: 1 })),
          onResult(idx2, slice2, next2) {
            const caught = pool[idx2];
            log('\u1F3B0', `Encounter: ${caught.name}`, 'log-capture');
            _spinQueue.unshift(makeCaptureResultStep(caught, cb));
            next2();
          }
        });
        next();
      }
    });
  }

  enqueueSpins(steps, () => {});
}

function getCaptureSuccessRate(pokemon) {
  // Linear: BST<=400 → 100%, BST=744 → 50%, clamped [50,100]
  const bst = pokemon.bst || 300;
  return Math.max(50, Math.min(100, Math.round(-0.14535 * bst + 158.14)));
}

function makeCaptureResultStep(pokemon, cb) {
  const successRate = getCaptureSuccessRate(pokemon);
  const failRate    = 100 - successRate;
  // Critical: 10% of the success slice (only if pokemon isn't legendary-tier)
  // Split: Fail=failRate, Critical=floor(successRate*0.10), Success=remainder
  const critWeight    = Math.floor(successRate * 0.10);
  const successWeight = successRate - critWeight;
  const slices = [
    { label: 'Fail',     weight: failRate },
    { label: 'Success',  weight: successWeight },
    { label: 'Critical', weight: critWeight },
  ].filter(s => s.weight > 0);

  return {
    prompt: `\u{1F3AF} ${pokemon.name} (BST\u00a0${pokemon.bst || '?'}) \u2014 catch rate\u00a0${successRate}%`,
    slices,
    onResult(idx, slice, next) {
      const result = slice.label;
      if (result === 'Fail') {
        log('\u{1F4A8}', `Capture failed! ${pokemon.name} escaped. (catch rate ${successRate}%)`, 'log-lose');
        setWheelResult(`${pokemon.name} escaped!`);
        cb();
        next();
      } else if (result === 'Critical') {
        log('\u{1F4A5}', `Critical capture! ${pokemon.name} + battle bonus +${DATA.balance.criticalBonus}%!`, 'log-crit');
        G.bonuses.criticalBonus = true;
        setWheelResult(`Critical! ${pokemon.name} caught!`);
        addToParty(pokemon, cb, next);
      } else {
        log('\u2705', `Caught ${pokemon.name}! (catch rate ${successRate}%)`, 'log-win');
        setWheelResult(`${pokemon.name} caught!`);
        addToParty(pokemon, cb, next);
      }
    }
  };
}

// Legacy helper (for forceRare path which builds steps array before enqueueing)
function pushCaptureResultStep(steps, pokemon, cb) {
  // We just push into the queue directly since steps array is already being processed
  _spinQueue.unshift(makeCaptureResultStep(pokemon, cb));
}

function addToParty(pokemon, cb, next) {
  if (G.party.length < 6) {
    G.party.push({ ...pokemon });
    log('\u2795', `${pokemon.name} joined the party!`, 'log-capture');
    renderAll();
    cb();
    next();
  } else {
    doPartyFullSpin(pokemon, cb, next);
  }
}

function doPartyFullSpin(newPokemon, cb, next) {
  const pfw = DATA.balance.partyFullWheel;
  const slices = Object.entries(pfw).map(([k, w]) => ({ label: formatPartyFullLabel(k), weight: w, action: k }));
  const stage = DATA.stages[G.stageIndex];
  log('\u1F4E6', 'Party full! Spin to decide...', 'log-info');
  _spinQueue.unshift({
    prompt: '\u1F4E6 Party full — what happens to the new Pokemon?',
    slices,
    onResult(idx, slice, next2) {
      const action = slice.action;
      if (action === 'DiscardNew') {
        log('\u1F5D1', `${newPokemon.name} discarded.`, 'log-info');
        setWheelResult(`${newPokemon.name} discarded!`);
        cb(); next2();
      } else if (action === 'ReplaceRandom') {
        const i = Math.floor(Math.random() * G.party.length);
        const removed = G.party[i];
        G.party[i] = { ...newPokemon };
        log('\u1F504', `Replaced ${removed.name} \u2192 ${newPokemon.name}.`, 'log-info');
        setWheelResult(`${removed.name} \u2192 ${newPokemon.name}`);
        renderAll(); cb(); next2();
      } else {
        const stageTypes = stage.stageTypes;
        let worstIdx = 0, worstVal = Infinity;
        G.party.forEach((p, i) => {
          const { value } = getPokemonMatchup(p, stageTypes);
          if (value < worstVal) { worstVal = value; worstIdx = i; }
        });
        const removed = G.party[worstIdx];
        G.party[worstIdx] = { ...newPokemon };
        log('\u1F504', `Replaced worst (${removed.name}) \u2192 ${newPokemon.name}.`, 'log-info');
        setWheelResult(`${removed.name} \u2192 ${newPokemon.name}`);
        renderAll(); cb(); next2();
      }
    }
  });
  next();
}

function formatPartyFullLabel(key) {
  return { ReplaceRandom: 'Replace Random', ReplaceWorstMatchup: 'Replace Worst', DiscardNew: 'Discard New' }[key] || key;
}

// ── Evolve ─────────────────────────────────────────────────────
function doEvolve(cb) {
  const evolvable = G.party.filter(p => p.evolvesTo);
  if (evolvable.length === 0) {
    log('\u274C', 'No evolvable Pokemon in party.', 'log-info');
    setWheelResult('No evolutions available!');
    cb(); return;
  }
  const stage = DATA.stages[G.stageIndex];
  const stageTypes = stage.stageTypes;
  enqueueSpins([{
    prompt: '\u2728 Evolve — Spin to pick which one!',
    slices: [
      { label: 'Random Evolvable', weight: 60, action: 'random' },
      { label: 'Worst Matchup', weight: 40, action: 'worst' },
    ],
    onResult(idx, slice, next) {
      let target;
      if (slice.action === 'random') {
        target = evolvable[Math.floor(Math.random() * evolvable.length)];
      } else {
        let worstVal = Infinity;
        for (const p of evolvable) {
          const { value } = getPokemonMatchup(p, stageTypes);
          if (value < worstVal) { worstVal = value; target = p; }
        }
      }
      const evolved = DATA.dexMap[target.evolvesTo];
      if (evolved) {
        const i = G.party.findIndex(p => p.dexNumber === target.dexNumber);
        if (i >= 0) {
          G.party[i] = { ...evolved };
          log('\u2728', `${target.name} \u2192 ${evolved.name}!`, 'log-evolve');
          setWheelResult(`${target.name} \u2192 ${evolved.name}!`);
          renderAll();
        }
      }
      cb(); next();
    }
  }], () => {});
}

// ── Find Item ──────────────────────────────────────────────────
function doFindItem(cb) {
  const fw = DATA.balance.findItemWheel;
  const slices = Object.entries(fw).map(([k, w]) => ({
    label: k === 'RunningShoes' ? 'Running Shoes' : k, weight: w, item: k
  }));
  log('\u1F50D', 'Find Item! Spin to see what you get.', 'log-item');
  enqueueSpins([{
    prompt: '\u1F50D Find Item — Spin!',
    slices,
    onResult(idx, slice, next) {
      if (slice.item === 'RunningShoes') {
        G.inventory.RunningShoes = true;
        log('\u1F45F', 'Running Shoes! +1 intermission spin per stage!', 'log-item');
      } else {
        G.inventory[slice.item]++;
        log('\u1F392', `Found ${slice.label}!`, 'log-item');
      }
      setWheelResult(`Found: ${slice.label}!`);
      renderAll(); cb(); next();
    }
  }], () => {});
}

// ── Bonus Slot ─────────────────────────────────────────────────
function doBonusSlot(cb) {
  if (G.party.length === 0) { cb(); return; }
  const stage = DATA.stages[G.stageIndex];
  const stageTypes = stage.stageTypes;
  const slices = [
    { label: 'Best Matchup', weight: 40, action: 'best' },
    { label: 'Random Party', weight: 60, action: 'random' },
  ];
  log('\u2B50', 'Bonus Slot! Spin to pick the helper.', 'log-item');
  enqueueSpins([{
    prompt: '\u2B50 Bonus Slot — Spin to pick!',
    slices,
    onResult(idx, slice, next) {
      let chosen;
      if (slice.action === 'best') {
        let bestVal = -1;
        for (const p of G.party) {
          const { value } = getPokemonMatchup(p, stageTypes);
          if (value > bestVal) { bestVal = value; chosen = p; }
        }
      } else {
        chosen = G.party[Math.floor(Math.random() * G.party.length)];
      }
      G.bonuses.bonusSlot = { ...chosen };
      log('\u2B50', `Bonus slot: ${chosen.name} for next battle!`, 'log-item');
      setWheelResult(`Bonus: ${chosen.name}!`);
      renderAll(); cb(); next();
    }
  }], () => {});
}

// ── Battle Phase ───────────────────────────────────────────────
function setupBattlePhase() {
  const stage = DATA.stages[G.stageIndex];
  G.phase = 'BATTLE';
  const kindLabel = { GYM: 'Gym Battle', E4: 'Elite Four', CHAMPION: 'Champion!' }[stage.stageKind] || 'Battle';
  setPhaseLabel(kindLabel, stage.stageName);
  updateSpinQueueLabel();

  const activeBonuses = [];
  if (G.inventory.TypeShield > 0) {
    G.inventory.TypeShield--;
    activeBonuses.push({ label: 'Type Shield', category: 'Shield', value: DATA.balance.typeShieldBonus });
    log('\u1F6E1', `Type Shield active! +${DATA.balance.typeShieldBonus}%`, 'log-item');
  }
  if (G.bonuses.criticalBonus) {
    activeBonuses.push({ label: 'Crit Bonus', category: 'Bonus', value: DATA.balance.criticalBonus });
    log('\u1F4A5', `Crit bonus! +${DATA.balance.criticalBonus}%`, 'log-crit');
    G.bonuses.criticalBonus = false;
  }

  let stageTypes = stage.stageTypes;
  if (stageTypes.includes('Mixed')) {
    const allTypes = Object.keys(DATA.typeChart);
    stageTypes = [
      allTypes[Math.floor(Math.random() * allTypes.length)],
      allTypes[Math.floor(Math.random() * allTypes.length)]
    ];
    log('\u1F300', `Champion uses: ${stageTypes.join(' / ')}`, 'log-info');
  }

  const battleParty = [...G.party];
  if (G.bonuses.bonusSlot) {
    battleParty.push({ ...G.bonuses.bonusSlot, _isBonus: true });
    log('\u2B50', `Bonus slot active: ${G.bonuses.bonusSlot.name}`, 'log-item');
  }

  const { chance, rawChance, pokemonContribSum, difficulty, jitter, breakdown } = computeWinChance(battleParty, stageTypes, activeBonuses, stage);
  renderBattleBreakdown(breakdown, chance, rawChance, difficulty, jitter, pokemonContribSum);
  log('\u1F4CA', `Raw:${rawChance} (base:${DATA.balance.winModel.baseChance}+poke:${pokemonContribSum}) | Opp:-${difficulty} | Jitter:${jitter>=0?'+':''}${jitter} | Final:${chance}%`, 'log-info');

  const slices = [
    { label: 'WIN!',   weight: chance },
    { label: 'LOSE...', weight: Math.max(1, 100 - chance) },
  ];
  wheelState.slices = buildWheel(slices);
  drawWheel(wheelState.slices, wheelState.angle);
  setWheelResult(`Spin to battle! Win chance: ${chance}%`);
  setPointerLabel('');

  setSpinHandler(() => {
    log('\u2694', `Battle vs ${stage.stageName} (${chance}% win)`, 'log-info');
    spinWheel(slices, (idx, slice) => {
      G.bonuses.bonusSlot = null;
      if (slice.label === 'WIN!') {
        log('\u1F3C6', `VICTORY vs ${stage.stageName}!`, 'log-win');
        setWheelResult(`Victory!${stage.badge ? ' ' + stage.badge + ' earned!' : ''}`);
        renderAll();
        advanceStage();
      } else {
        log('\u1F480', `DEFEAT vs ${stage.stageName}...`, 'log-lose');
        setWheelResult('Defeat! Checking bag...');
        renderAll();
        handleDefeat(stage, stageTypes);
      }
    });
  });
}

function handleDefeat(stage, stageTypes) {
  if (G.inventory.LuckyCharm > 0) {
    G.inventory.LuckyCharm--;
    log('\u1F340', 'Lucky Charm used! Rerolling battle...', 'log-item');
    renderAll();
    retryBattle(stage, stageTypes, false);
  } else if (G.inventory.Potion > 0) {
    G.inventory.Potion--;
    log('\u1F9EA', 'Potion used! Retrying battle...', 'log-item');
    renderAll();
    retryBattle(stage, stageTypes, true);
  } else {
    endRun(false, stage.stageName);
  }
}

function retryBattle(stage, stageTypes, usedPotion) {
  const { chance, rawChance, pokemonContribSum, difficulty, jitter, breakdown } = computeWinChance(G.party, stageTypes, [], stage);
  renderBattleBreakdown(breakdown, chance, rawChance, difficulty, jitter, pokemonContribSum);
  const slices = [
    { label: 'WIN!',   weight: chance },
    { label: 'LOSE...', weight: Math.max(1, 100 - chance) },
  ];
  wheelState.slices = buildWheel(slices);
  drawWheel(wheelState.slices, wheelState.angle);
  setWheelResult(`Retry! Win chance: ${chance}%`);
  setPointerLabel('');
  log('\u1F504', `Retry — ${chance}% win chance`, 'log-info');

  setSpinHandler(() => {
    spinWheel(slices, (idx, slice) => {
      if (slice.label === 'WIN!') {
        log('\u1F3C6', `VICTORY on retry vs ${stage.stageName}!`, 'log-win');
        setWheelResult('Victory on retry!');
        renderAll();
        advanceStage();
      } else {
        if (!usedPotion && G.inventory.Potion > 0) {
          G.inventory.Potion--;
          log('\u1F9EA', 'Potion used! Retrying...', 'log-item');
          renderAll();
          retryBattle(stage, stageTypes, true);
        } else {
          endRun(false, stage.stageName);
        }
      }
    });
  });
}

function advanceStage() {
  G.stageIndex++;
  if (G.stageIndex >= DATA.stages.length) { endRun(true); return; }
  G.phase = 'INTERMISSION';
  G.intermissionSpinsLeft = getIntermissionSpins();
  renderAll();
  setupIntermissionWheel();
}

function endRun(win, stageName) {
  G.phase = 'END';
  G.runEnded = true;
  renderAll();
  document.getElementById('overlay').classList.remove('hidden');
  document.getElementById('overlay-title').textContent = win ? '\u1F3C6 CHAMPION!' : '\u1F480 RUN OVER';
  document.getElementById('overlay-msg').textContent = win
    ? `You conquered all of Kanto! Party: ${G.party.map(p=>p.name).join(', ')}`
    : `Defeated by ${stageName || '???'}. Party: ${G.party.map(p=>p.name).join(', ') || 'none'}`;
  log(win ? '\u1F3C6' : '\u1F480', win ? 'Hall of Fame!' : `Run ended at: ${stageName}`, win ? 'log-win' : 'log-lose');
}

// ── Render ─────────────────────────────────────────────────────
function renderAll() {
  renderParty();
  renderInventory();
  renderStageInfo();
  renderWinChance();
}

function renderParty() {
  const grid = document.getElementById('party-grid');
  const slots = grid.querySelectorAll('.party-slot');
  slots.forEach((slot, i) => {
    slot.className = 'party-slot';
    slot.innerHTML = '';
    if (i < G.party.length) {
      const p = G.party[i];
      slot.classList.add('filled');
      if (p._isBonus) slot.classList.add('bonus');
      const nameEl = document.createElement('div');
      nameEl.className = 'slot-name';
      nameEl.textContent = p.name;
      const typesEl = document.createElement('div');
      typesEl.className = 'slot-types';
      [p.type1, p.type2].filter(Boolean).forEach(t => {
        const badge = document.createElement('span');
        badge.className = `type-badge type-${t}`;
        badge.textContent = t;
        typesEl.appendChild(badge);
      });
      slot.appendChild(nameEl);
      slot.appendChild(typesEl);
      if (G.stageIndex < DATA.stages.length) {
        const st = DATA.stages[G.stageIndex].stageTypes.filter(t => t !== 'Mixed');
        if (st.length > 0) {
          const { category, value } = getPokemonMatchup(p, st);
          const contEl = document.createElement('div');
          contEl.className = 'slot-contrib';
          contEl.textContent = `+${value} (${category[0]})`;
          slot.appendChild(contEl);
        }
      }
    } else {
      slot.classList.add('empty');
    }
  });
  const existing = grid.querySelector('.bonus-note');
  if (existing) existing.remove();
  if (G.bonuses && G.bonuses.bonusSlot) {
    const note = document.createElement('div');
    note.className = 'bonus-note';
    note.style.cssText = 'grid-column:1/-1;padding:4px;font-family:var(--pixel-font);font-size:0.38rem;color:var(--accent2);border-top:1px solid var(--border);margin-top:4px;';
    note.textContent = `\u2B50 Bonus slot: ${G.bonuses.bonusSlot.name}`;
    grid.appendChild(note);
  }
}

function renderInventory() {
  const list = document.getElementById('inventory-list');
  list.innerHTML = '';
  [['Potion','\u1F9EA','Potion'],['TypeShield','\u1F6E1','Type Shield'],['LuckyCharm','\u1F340','Lucky Charm']].forEach(([key, icon, name]) => {
    const row = document.createElement('div');
    row.className = 'inv-row';
    row.innerHTML = `<span class="inv-name">${icon} ${name}</span><span class="inv-count">\u00D7${G.inventory[key]}</span>`;
    list.appendChild(row);
  });
  const shoes = document.createElement('div');
  shoes.className = 'inv-row';
  shoes.innerHTML = `<span class="inv-name">\u1F45F Running Shoes</span><span class="inv-permanent">${G.inventory.RunningShoes ? '\u2713 Active' : '\u2014'}</span>`;
  list.appendChild(shoes);
  if (G.bonuses && G.bonuses.criticalBonus) {
    const cb = document.createElement('div');
    cb.className = 'inv-row';
    cb.innerHTML = `<span class="inv-name">\u1F4A5 Crit Bonus</span><span class="inv-permanent">+${DATA.balance.criticalBonus}%</span>`;
    list.appendChild(cb);
  }
}

function renderStageInfo() {
  const info = document.getElementById('stage-info');
  if (G.stageIndex >= DATA.stages.length) {
    info.innerHTML = '<strong>\u1F3C6 All stages cleared!</strong>'; return;
  }
  const stage = DATA.stages[G.stageIndex];
  info.innerHTML = `
    <div><strong>${stage.stageName}</strong></div>
    <div>${stage.stageKind} \u2014 ${stage.stageTypes.join(' / ')}</div>
    ${stage.leader ? `<div>Leader: ${stage.leader}</div>` : ''}
    ${stage.badge ? `<div>Badge: ${stage.badge}</div>` : ''}
    <div style="margin-top:4px;color:var(--text2)">${G.stageIndex + 1} / ${DATA.stages.length}</div>
  `;
}

function renderWinChance() {
  if (G.party.length === 0 || G.stageIndex >= DATA.stages.length) {
    document.getElementById('win-chance-pct').textContent = '\u2014%';
    document.getElementById('win-chance-fill').style.width = '0%';
    document.getElementById('battle-breakdown').innerHTML = '';
    return;
  }
  const stage = DATA.stages[G.stageIndex];
  let stageTypes = stage.stageTypes.filter(t => t !== 'Mixed');
  if (stageTypes.length === 0) stageTypes = ['Normal'];
  const battleParty = [...G.party];
  if (G.bonuses && G.bonuses.bonusSlot) battleParty.push({ ...G.bonuses.bonusSlot });
  const bonuses = [];
  if (G.inventory.TypeShield > 0) bonuses.push({ label: 'Type Shield', category: 'Shield', value: DATA.balance.typeShieldBonus });
  if (G.bonuses && G.bonuses.criticalBonus) bonuses.push({ label: 'Crit Bonus', category: 'Bonus', value: DATA.balance.criticalBonus });
  const { chance, rawChance, pokemonContribSum, difficulty, jitter, breakdown } = computeWinChance(battleParty, stageTypes, bonuses, stage);
  renderBattleBreakdown(breakdown, chance, rawChance, difficulty, jitter, pokemonContribSum);
}

function renderBattleBreakdown(breakdown, chance, rawChance, difficulty, jitter, pokemonContribSum) {
  document.getElementById('win-chance-pct').textContent = `${chance}%`;
  const fill = document.getElementById('win-chance-fill');
  fill.style.width = `${chance}%`;
  fill.style.background = chance >= 70 ? 'var(--accent3)' : chance >= 40 ? '#f8d030' : 'var(--accent2)';

  const wm = DATA.balance.winModel;
  const catLabel = { VeryStrong: '\u26a1\u26a1', Strong: '\u26a1', Neutral: '\u2014', Resisted: '\u25bd' };

  let html = `<div class="contrib-row"><span style="color:var(--text2)">Base chance</span><span class="contrib-vs">+${wm.baseChance}</span></div>`;

  for (const row of breakdown) {
    if (row.kind === 'pokemon') {
      const multP = row.mult !== undefined ? ` \xd7${row.mult}` : '';
      const bstStr = row.bst ? ` BST\u00a0${row.bst}` : '';
      const cat = catLabel[row.category] || row.category;
      html += `<div class="contrib-row">
        <span><b style="color:var(--text)">${row.name}</b>
          <small style="display:block;color:var(--text2);line-height:1.3">${bstStr} \u2192 base\u00a0${row.baseContrib}%${multP} ${cat}</small>
        </span>
        <span class="contrib-vs">+${row.value}%</span>
      </div>`;
    } else {
      html += `<div class="contrib-row">
        <span style="color:var(--accent)">\u2606\u00a0${row.name}</span>
        <span class="contrib-bonus">+${row.value}%</span>
      </div>`;
    }
  }

  if (rawChance !== undefined) {
    html += `<div class="contrib-row" style="border-top:1px dashed var(--border);margin-top:3px;padding-top:3px">
      <span style="color:var(--text2)">Raw chance</span><span style="color:var(--text2)">${rawChance}%</span>
    </div>`;
  }
  if (difficulty !== undefined && difficulty > 0) {
    html += `<div class="contrib-row">
      <span style="color:var(--accent2)">\u2694\ufe0f Opponent strength</span>
      <span style="color:var(--accent2)">\u2212${difficulty}%</span>
    </div>`;
  }
  if (jitter !== undefined && jitter !== 0) {
    const s = jitter > 0 ? '+' : '';
    const c = jitter > 0 ? 'var(--accent3)' : 'var(--accent2)';
    html += `<div class="contrib-row">
      <span style="color:${c}">\uD83C\uDFB2 Stage jitter</span>
      <span style="color:${c}">${s}${jitter}%</span>
    </div>`;
  }
  html += `<div class="contrib-row" style="font-family:var(--pixel-font);font-size:0.4rem;border-top:2px solid var(--border);margin-top:4px;padding-top:4px;font-weight:bold">
    <span>Final win %</span><span>${chance}%</span>
  </div>`;

  document.getElementById('battle-breakdown').innerHTML = html;
}

// ── Spin Button ────────────────────────────────────────────────
let _spinHandler = null;

function setSpinHandler(fn) {
  _spinHandler = fn;
  document.getElementById('spinBtn').disabled = false;
}

function setPhaseLabel(phase, stage) {
  document.getElementById('phase-label').textContent = phase;
  document.getElementById('stage-label').textContent = stage;
}

function setWheelResult(text) {
  document.getElementById('wheel-result-label').textContent = text;
}

function log(icon, msg, cls = 'log-info') {
  const logEl = document.getElementById('run-log');
  const entry = document.createElement('div');
  entry.className = `log-entry ${cls}`;
  entry.innerHTML = `<span class="log-icon">${icon}</span>${msg}`;
  logEl.appendChild(entry);
  logEl.scrollTop = logEl.scrollHeight;
}

document.getElementById('spinBtn').addEventListener('click', () => {
  if (wheelState.spinning || G.runEnded) return;
  if (_spinHandler) {
    document.getElementById('spinBtn').disabled = true;
    _spinHandler();
  }
});

// ── Dark Mode ──────────────────────────────────────────────────
document.getElementById('darkModeToggle').addEventListener('click', () => {
  const next = document.documentElement.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
  document.documentElement.setAttribute('data-theme', next);
  document.getElementById('darkModeToggle').textContent = next === 'dark' ? '\u263E' : '\u2600';
  if (wheelState.slices.length > 0) drawWheel(wheelState.slices, wheelState.angle);
});

// ── Restart ────────────────────────────────────────────────────
function doRestart() {
  document.getElementById('overlay').classList.add('hidden');
  document.getElementById('spinBtn').disabled = false;
  _spinHandler = null;
  _spinQueue = [];
  _onQueueDone = null;
  initGame();
}
document.getElementById('restartBtn').addEventListener('click', doRestart);
document.getElementById('overlay-restart').addEventListener('click', doRestart);

// ── Boot ───────────────────────────────────────────────────────

// ── Calibration (dev-only — logs to console on boot) ──────────
function runCalibration() {
  const starters = [DATA.dexMap[1], DATA.dexMap[4], DATA.dexMap[7]];
  function avgContrib(stageIdx) {
    return starters.reduce((s, p) => {
      const types = DATA.stages[stageIdx > 0 ? stageIdx : 0].stageTypes.filter(t => t !== 'Mixed');
      return s + getPokemonMatchup(p, types.length ? types : ['Normal'], stageIdx).value;
    }, 0) / starters.length;
  }
  const k = DATA.balance.winModel.bstFormula.k;
  const b = DATA.balance.winModel.bstFormula.b;
  console.group('%c[RNG Gym Run] BST Calibration', 'color:#f8e71c;font-weight:bold');
  console.log('Formula: BST * ' + k + ' + ' + b + ' then x stageMultiplier');
  console.log('Bulbasaur BST=318 @ Gym1: +' + Math.round(318*k+b) + '% base, +' + Math.round((318*k+b)*1.0) + '% final');
  console.log('Mewtwo    BST=680 @ Gym1: +' + Math.round(680*k+b) + '% base');
  console.log('Snorlax   BST=590 @ Gym1: +' + Math.round(590*k+b) + '% base');
  console.log('Magikarp  BST=200 @ Gym1: +' + Math.round(200*k+b) + '% base');
  const multChamp = DATA.balance.winModel.stageContributionMultiplier;
  const tChamp = (DATA.stages.length-1)/(DATA.stages.length-1);
  const multC = multChamp.multEarly + (multChamp.multLate - multChamp.multEarly) * tChamp;
  console.log('Bulbasaur @ Champion (mult=' + multC.toFixed(3) + '): +' + Math.round((318*k+b)*multC) + '%');
  console.groupEnd();
}

loadData();
initGame();
runCalibration();

</script>
</body>
</html>
